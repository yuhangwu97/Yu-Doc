# 签到金币功能API集成文档

---

## 功能

1. **金币余额查询** - 查询用户当前金币余额、现金余额及兑换信息
2. **签到列表** - 获取7天签到配置列表，显示每日签到状态和奖励
3. **立即签到** - 执行签到操作，领取当日签到奖励
4. **邀请绑定和注册奖励** - 新用户通过邀请注册时自动绑定关系并奖励100金币

---

## 1. 金币余额查询

### 接口说明
查询用户当前的金币余额、现金余额以及金币兑换相关信息。该接口会自动创建会员签到信息（如果不存在）。

### 接口地址
```
GET /appSignInApi/memberGoldCoin
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `memberId` | String | 是 | 会员ID |
| `sysOrgCode` | String | 是 | 部门编号 |

### 请求示例
```
GET /appSignInApi/memberGoldCoin?memberId=123456&sysOrgCode=A01
```

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "goldCoin": "我的金币",
    "totalPrice": 150,
    "exchange": "100金币=1元,每天0点自动兑换成现金",
    "exchangeWay": "每天0点自动兑换成现金",
    "cashBalance": 1.50
  },
  "timestamp": 1234567890
}
```

#### 返回字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `goldCoin` | String | 金币名称（格式：我的+币值名称，如"我的金币"） |
| `totalPrice` | Integer | 用户当前金币余额 |
| `exchange` | String | 兑换提示信息（格式：兑换比例+币值名称=1元,兑换方式） |
| `exchangeWay` | String | 兑换方式（"每天0点自动兑换成现金" 或 "用户随时兑换成现金"） |
| `cashBalance` | BigDecimal | 用户现金余额 |

### 业务逻辑说明

1. **自动创建会员信息**：如果会员签到信息不存在，接口会自动创建
2. **兑换比例**：从签到福利配置表中获取兑换比例和币值名称
3. **兑换方式**：根据会员的`exchangeWay`字段判断（1-每天0点自动兑换，2-用户随时兑换）

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请传入会员ID(memberId)` | memberId参数为空 | 检查请求参数 |
| `请传入部门编号(sysOrgCode)` | sysOrgCode参数为空 | 检查请求参数 |
| `请检查是否配置APP签到福利信息！` | 部门下未配置签到福利信息 | 联系管理员配置签到福利信息 |

### 使用建议

1. **页面展示**：显示`totalPrice`作为用户金币余额，`cashBalance`作为现金余额
2. **兑换提示**：使用`exchange`字段显示兑换规则提示
3. **刷新机制**：签到成功后，建议重新调用此接口刷新余额显示

---

## 2. 签到列表

### 接口说明
获取7天签到配置列表，显示每日签到的状态（已签到/未签到）、奖励金币数量等信息。接口会根据用户昨天的签到情况，自动判断今天应该签到第几天，并标记今日签到状态。

### 接口地址
```
GET /appSignInApi/signinManageList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `memberId` | String | 是 | 会员ID |
| `sysOrgCode` | String | 是 | 部门编号 |

### 请求示例
```
GET /appSignInApi/signinManageList?memberId=123456&sysOrgCode=A01
```

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "list": [
      {
        "id": "signin001",
        "signInName": "第1天",
        "currencyQuantity": 10,
        "sort": 1,
        "receiveStatus": true,
        "receive": "已领",
        "icon": "https://example.com/received.png"
      },
      {
        "id": "signin002",
        "signInName": "第2天",
        "currencyQuantity": 15,
        "sort": 2,
        "receiveStatus": true,
        "receive": "已领",
        "icon": "https://example.com/received.png"
      },
      {
        "id": "signin003",
        "signInName": "第3天",
        "currencyQuantity": 20,
        "sort": 3,
        "receiveStatus": false,
        "receive": "今天",
        "icon": "https://example.com/unreceived.png"
      },
      {
        "id": "signin004",
        "signInName": "第4天",
        "currencyQuantity": 25,
        "sort": 4,
        "receiveStatus": false,
        "receive": "第4天",
        "icon": "https://example.com/unreceived.png"
      },
      {
        "id": "signin005",
        "signInName": "第5天",
        "currencyQuantity": 30,
        "sort": 5,
        "receiveStatus": false,
        "receive": "第5天",
        "icon": "https://example.com/unreceived.png"
      },
      {
        "id": "signin006",
        "signInName": "第6天",
        "currencyQuantity": 35,
        "sort": 6,
        "receiveStatus": false,
        "receive": "第6天",
        "icon": "https://example.com/unreceived.png"
      },
      {
        "id": "signin007",
        "signInName": "第7天",
        "currencyQuantity": 50,
        "sort": 7,
        "receiveStatus": false,
        "receive": "第7天",
        "icon": "https://example.com/unreceived.png"
      }
    ],
    "total": 185,
    "today": 20,
    "currencyName": "金币",
    "receiveStatus": 2,
    "signInId": "signin003",
    "totalDays": 7,
    "totalCash": 1.85
  },
  "timestamp": 1234567890
}
```

#### 返回字段说明

##### 根级字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `list` | Array | 签到列表（7天签到配置） |
| `total` | Integer | 连续签到可获得的总金币数（7天累计） |
| `today` | Integer | 今天签到可获得的金币数量 |
| `currencyName` | String | 币值名称（如"金币"） |
| `receiveStatus` | Integer | 今天是否签到（1-已签到，2-未签到） |
| `signInId` | String | 今天可签到的签到ID（用于立即签到接口，如果已签到则为null） |
| `totalDays` | Integer | 总天数（通常为7） |
| `totalCash` | BigDecimal | 连续签到可获得的总现金数（根据兑换比例计算） |

##### 列表项字段（list数组中的对象）

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | String | 签到ID（用于立即签到接口） |
| `signInName` | String | 签到标题（如"第1天"、"第2天"等） |
| `currencyQuantity` | Integer | 该天签到可获得的金币数量 |
| `sort` | Integer | 排序序号 |
| `receiveStatus` | Boolean | 领取状态（true-已领取，false-未领取） |
| `receive` | String | 领取状态文本（"已领"、"今天"或签到标题） |
| `icon` | String | 图标URL（已领取图标或未领取图标） |

### 业务逻辑说明

#### 签到状态判断规则

1. **连续签到**：如果昨天已签到且不是最后一天，今天继续签到下一天
2. **重新开始**：如果昨天未签到，或昨天是最后一天，今天从第1天重新开始
3. **今日状态**：
   - `receiveStatus = 1`：今天已签到，`signInId`为null
   - `receiveStatus = 2`：今天未签到，`signInId`为今天可签到的签到ID

#### 列表项状态说明

- **已领取**：`receiveStatus = true`，`receive = "已领"`，显示已领取图标
- **今天可签到**：`receiveStatus = false`，`receive = "今天"`，显示未领取图标，`id`作为`signInId`返回
- **未到时间**：`receiveStatus = false`，`receive = 签到标题`（如"第4天"），显示未领取图标

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请传入部门编号(sysOrgCode)` | sysOrgCode参数为空 | 检查请求参数 |
| `请传入会员ID(memberId)` | memberId参数为空 | 检查请求参数 |

### 使用建议

1. **列表展示**：使用`list`数组渲染7天签到列表
2. **状态显示**：
   - `receiveStatus = true`：显示已领取状态，使用已领取图标
   - `receiveStatus = false` 且 `receive = "今天"`：高亮显示，提示用户今天可签到
   - 其他：显示未领取状态
3. **签到按钮**：当`receiveStatus = 2`时，显示签到按钮，使用`signInId`调用立即签到接口
4. **奖励提示**：显示`today`作为今日签到奖励，`total`作为连续签到总奖励
5. **刷新机制**：签到成功后，重新调用此接口刷新列表状态

---

## 3. 立即签到

### 接口说明
执行签到操作，领取当日签到奖励。接口会验证今日是否已签到，如果已签到则返回错误。签到成功后会：
- 增加用户金币余额
- 记录签到明细
- 添加分销记录（如果启用）

### 接口地址
```
GET /appSignInApi/addSigninWelfare
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `memberId` | String | 是 | 会员ID |
| `sysOrgCode` | String | 是 | 部门编号 |
| `signInId` | String | 是 | 签到ID（从签到列表接口获取，对应今天可签到的签到项id） |

### 请求示例
```
GET /appSignInApi/addSigninWelfare?memberId=123456&sysOrgCode=A01&signInId=signin003
```

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": 20,
  "timestamp": 1234567890
}
```

#### 返回字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `result` | Integer | 本次签到获得的金币数量 |

### 业务逻辑说明

1. **验证签到状态**：检查今日是否已领取该签到奖励，如果已领取则返回错误
2. **获取奖励数量**：根据`signInId`从签到配置中获取该天应获得的金币数量
3. **更新用户余额**：将金币数量累加到用户的金币余额中
4. **记录签到明细**：创建签到金币明细记录
5. **分销处理**：如果启用分销功能，会添加分销记录

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请传入会员id(memberId)` | memberId参数为空 | 检查请求参数 |
| `请传入部门编号(sysOrgCode)` | sysOrgCode参数为空 | 检查请求参数 |
| `请传入领取id(signInId)` | signInId参数为空 | 检查请求参数 |
| `该条签到奖励今日已领取！` | 今日已签到 | 提示用户今日已签到，无需重复签到 |

### 使用建议

1. **签到流程**：
   - 调用签到列表接口获取`signInId`
   - 使用`signInId`调用立即签到接口
   - 签到成功后，显示获得的金币数量（`result`字段）
   - 重新调用签到列表接口和金币余额查询接口，刷新页面数据
2. **错误处理**：
   - 如果返回"今日已领取"错误，提示用户并禁用签到按钮
   - 其他错误信息友好提示用户
3. **用户体验**：
   - 签到过程中显示加载状态
   - 签到成功后显示成功提示和获得的金币数量
   - 自动刷新相关数据

---

## 4. 邀请绑定和注册奖励

### 功能说明
当新用户通过邀请链接注册时，系统会自动：
1. **绑定邀请关系**：建立新用户与邀请人之间的分销绑定关系
2. **奖励金币**：给新注册用户自动奖励100金币

该功能已集成到所有注册接口中，无需额外调用接口，只需在注册时传递邀请人ID即可。

### 支持的注册接口

以下三个注册接口均支持邀请绑定和奖励功能：

1. **账号注册**：`GET /appApi/memberAccountNumberAdd`
2. **验证码注册**：`GET /appApi/memberCaptchaAdd`
3. **授权注册**（微信/支付宝）：`GET /appApi/filmDramaMemberAdd`

### 请求参数

在调用上述注册接口时，可选的添加以下参数：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `bindMemberId` | String | 否 | 邀请人会员ID（从邀请链接或二维码中获取） |

### 请求示例

#### 账号注册（带邀请）
```
GET /appApi/memberAccountNumberAdd?accountNumber=13800138000&password=123456&sysOrgCode=A01&bindMemberId=66666666
```

#### 验证码注册（带邀请）
```
GET /appApi/memberCaptchaAdd?accountNumber=13800138000&logonCode=123456&sysOrgCode=A01&bindMemberId=66666666
```

#### 授权注册（带邀请）
```
GET /appApi/filmDramaMemberAdd?code=xxx&appId=xxx&sysOrgCode=A01&bindMemberId=66666666
```

### 业务逻辑说明

1. **自动处理**：注册成功后，如果传递了`bindMemberId`参数，系统会自动执行以下操作：
   - 调用分销绑定接口，建立新用户与邀请人的绑定关系
   - 给新注册用户的金币余额增加100金币

2. **异常处理**：
   - 邀请绑定失败不会影响注册流程，只会记录日志
   - 如果邀请人不存在或处于禁用状态，绑定会失败但不影响用户注册
   - 如果用户已存在绑定关系，会根据业务规则处理（可能更新或保持原关系）

3. **奖励对象**：
   - **奖励给新用户**：100金币是奖励给新注册的用户，不是给邀请人
   - **仅新注册**：只有新注册的用户才会获得奖励，已存在的用户登录不会触发奖励

### 使用场景

#### 场景1：邀请链接注册
1. 用户A分享邀请链接：`https://app.example.com/register?bindMemberId=66666666`
2. 用户B点击链接，跳转到注册页面
3. 前端从URL中提取`bindMemberId=66666666`
4. 用户B完成注册，调用注册接口时带上`bindMemberId`参数
5. 注册成功后，系统自动：
   - 绑定用户B与用户A的邀请关系
   - 给用户B奖励100金币

#### 场景2：邀请二维码注册
1. 用户A生成邀请二维码，二维码中包含`bindMemberId`参数
2. 用户B扫码后，跳转到注册页面，URL中包含`bindMemberId`
3. 用户B完成注册流程，前端自动将`bindMemberId`传递给注册接口
4. 注册成功后自动绑定和奖励

### 注意事项

1. **参数可选**：`bindMemberId`是可选参数，不传递时不会影响正常注册流程
2. **仅新注册**：只有新用户注册时才会触发奖励，已存在用户登录不会触发
3. **绑定规则**：邀请绑定遵循分销系统的绑定规则，可能存在以下情况：
   - 如果用户已存在绑定关系，可能不会更新
   - 如果邀请人处于禁用状态，绑定会失败
   - 如果邀请人不存在，绑定会失败
4. **奖励金额**：固定奖励100金币，奖励给新注册的用户
5. **失败不影响注册**：即使邀请绑定失败，用户注册仍然成功，只是不会建立绑定关系和获得奖励
6. **验证金币余额**：注册成功后，可以调用金币余额查询接口验证是否已获得100金币奖励

### 验证奖励是否成功

注册成功后，可以通过以下方式验证：

1. **查询金币余额**：调用 `GET /appSignInApi/memberGoldCoin` 接口，检查`totalPrice`是否包含100金币
2. **查询绑定关系**：调用分销相关接口查询是否已建立绑定关系

### 常见问题

**Q: 如果用户已经注册过，再次使用邀请链接注册会怎样？**
A: 如果用户已存在，注册接口会返回已存在的用户信息，不会重复绑定和奖励。

**Q: 邀请绑定失败会影响用户注册吗？**
A: 不会。邀请绑定失败只会记录日志，不会影响用户注册流程。

**Q: 奖励是给新用户还是邀请人？**
A: 奖励是给新注册的用户，不是给邀请人。

**Q: 可以修改奖励金额吗？**
A: 目前固定为100金币，如需修改需要联系后端开发人员。

---

## 接口调用流程

### 完整签到流程

1. **查询金币余额**：调用 `GET /appSignInApi/memberGoldCoin` 接口获取用户当前金币余额
2. **获取签到列表**：调用 `GET /appSignInApi/signinManageList` 接口获取7天签到列表和今日签到状态
3. **判断是否可以签到**：检查返回的 `receiveStatus` 字段（值为2表示未签到，可以签到）
4. **执行签到**：如果可签到，使用返回的 `signInId` 调用 `GET /appSignInApi/addSigninWelfare` 接口
5. **刷新数据**：签到成功后，重新调用金币余额查询和签到列表接口，刷新页面数据

### 注意事项

1. **参数必填**：所有接口的`memberId`和`sysOrgCode`都是必填参数
2. **签到ID**：立即签到接口的`signInId`必须从签到列表接口获取，不能使用固定的ID
3. **重复签到**：同一天不能重复签到，接口会验证并返回错误
4. **数据刷新**：签到成功后建议重新调用相关接口刷新页面数据
5. **错误处理**：所有接口都可能返回错误，需要做好错误提示处理

---

## 数据字典

### receiveStatus 签到状态

| 值 | 说明 |
|----|------|
| 1 | 今天已签到 |
| 2 | 今天未签到 |

### receiveStatus（列表项）领取状态

| 值 | 说明 |
|----|------|
| true | 已领取 |
| false | 未领取 |

### receive 领取状态文本

| 值 | 说明 |
|----|------|
| "已领" | 该天已签到 |
| "今天" | 今天可签到 |
| "第X天" | 未到签到时间 |

---

## 相关接口

### 签到相关接口
- **金币余额查询**：`GET /appSignInApi/memberGoldCoin`
- **签到列表查询**：`GET /appSignInApi/signinManageList`
- **立即签到**：`GET /appSignInApi/addSigninWelfare`

### 注册相关接口（支持邀请绑定）
- **账号注册**：`GET /appApi/memberAccountNumberAdd`（支持`bindMemberId`参数）
- **验证码注册**：`GET /appApi/memberCaptchaAdd`（支持`bindMemberId`参数）
- **授权注册**：`GET /appApi/filmDramaMemberAdd`（支持`bindMemberId`参数）

