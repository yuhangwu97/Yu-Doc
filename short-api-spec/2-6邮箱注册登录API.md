# 邮箱注册登录API集成文档


---

## 功能

1. **发送邮箱验证码** - 发送邮箱验证码用于注册、登录或忘记密码
2. **邮箱注册** - 使用邮箱和验证码进行用户注册
3. **邮箱登录** - 支持密码登录和验证码登录两种方式
4. **重置密码** - 通过邮箱验证码重置用户密码

---

## 1. 发送邮箱验证码

### 接口说明
发送邮箱验证码接口，支持三种模式：登录模式、注册模式、忘记密码模式。验证码有效期为10分钟，10分钟内不能重复发送。

### 接口地址
```
POST /api/sys/sendEmailCode
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `email` | String | 是 | 邮箱地址 |
| `emailmode` | String | 是 | 模式：`"0"`-登录模式，`"1"`-注册模式，`"2"`-忘记密码模式 |

### 请求示例
```json
{
  "email": "user@example.com",
  "emailmode": "1"
}
```

### 业务逻辑说明

#### 注册模式（emailmode = "1"）
- 检查邮箱是否已注册，如果已注册则返回错误："邮箱已经注册，请直接登录！"
- 如果邮箱未注册，发送验证码

#### 登录模式（emailmode = "0"）
- 检查用户是否存在且有效
- 如果用户不存在或未绑定邮箱，返回错误："该用户不存在或未绑定邮箱"
- 如果用户存在且有效，发送验证码

#### 忘记密码模式（emailmode = "2"）
- 检查用户是否存在且有效
- 如果用户不存在，返回错误
- 如果用户存在且有效，发送验证码

### 验证码规则
- 验证码为6位数字
- 验证码有效期为10分钟（600秒）
- 10分钟内如果验证码仍然有效，不能重复发送
- 验证码存储在Redis中，key格式：`email_msg{email}`

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "验证码发送成功",
  "code": 200,
  "result": null,
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "邮箱格式不正确！",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `邮箱地址不允许为空！` | email参数为空 | 检查请求参数 |
| `邮箱格式不正确！` | 邮箱格式不符合规范 | 校验邮箱格式 |
| `验证码10分钟内仍然有效！` | 10分钟内已发送过验证码 | 提示用户等待或使用已发送的验证码 |
| `邮箱已经注册，请直接登录！` | 注册模式下，邮箱已被注册 | 提示用户直接登录 |
| `该用户不存在或未绑定邮箱` | 登录模式下，用户不存在或未绑定邮箱 | 提示用户注册或检查邮箱 |
| `邮箱验证码发送失败，请稍后重试` | 发送邮件失败 | 提示用户稍后重试 |

### 前端处理建议
1. **邮箱格式校验**：前端应先进行邮箱格式校验，减少无效请求
2. **倒计时功能**：发送验证码后，显示60秒倒计时，防止频繁点击
3. **错误提示**：根据返回的错误信息，给用户友好的提示
4. **验证码输入**：建议使用6位数字输入框，提升用户体验

---

## 2. 邮箱注册

### 接口说明
用户注册接口，支持邮箱注册和手机号注册两种方式。如果同时提供邮箱和手机号，优先使用手机号注册。注册成功后，验证码会被自动删除。

### 接口地址
```
POST /api/sys/user/register
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `email` | String | 是（邮箱注册时） | 邮箱地址 |
| `emailcode` | String | 是（邮箱注册时） | 邮箱验证码 |
| `phone` | String | 否 | 手机号（可选，如果提供需要同时提供smscode） |
| `smscode` | String | 否 | 手机验证码（可选，如果提供需要同时提供phone） |
| `username` | String | 否 | 用户名，如果不提供则使用邮箱作为用户名 |
| `password` | String | 否 | 密码，如果不提供则自动生成8位随机密码 |
| `realname` | String | 否 | 真实姓名，如果不提供则使用用户名 |

### 请求示例（邮箱注册）
```json
{
  "email": "user@example.com",
  "emailcode": "123456",
  "username": "myusername",
  "password": "mypassword",
  "realname": "张三"
}
```

### 业务逻辑说明

#### 注册方式判断
- 必须至少提供一种注册方式：`邮箱+邮箱验证码` 或 `手机号+手机验证码`
- 如果同时提供两种方式，优先使用手机号注册

#### 邮箱注册流程
1. 如果未提供用户名，使用邮箱作为用户名
2. 检查用户名是否已注册
3. 检查邮箱是否已注册
4. 如果提供了手机号，检查手机号是否已注册
5. 验证邮箱验证码是否正确
6. 验证码验证成功后，创建用户并删除验证码

#### 验证码验证
- 从Redis中获取验证码：key格式为`email_msg{email}`
- 如果验证码不存在，返回："邮箱验证码失效，请重新获取"
- 如果验证码不匹配，返回："邮箱验证码错误"
- 验证成功后，删除Redis中的验证码

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "注册成功",
  "code": 200,
  "result": null,
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "邮箱验证码错误",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请提供手机号+验证码或邮箱+验证码进行注册` | 未提供有效的注册信息 | 检查请求参数 |
| `用户名已注册` | 用户名已被使用 | 提示用户更换用户名 |
| `邮箱已被注册` | 邮箱已被注册 | 提示用户直接登录 |
| `该手机号已注册` | 手机号已被注册 | 提示用户更换手机号 |
| `邮箱验证码失效，请重新获取` | 验证码过期或不存在 | 提示用户重新获取验证码 |
| `邮箱验证码错误` | 验证码不匹配 | 提示用户检查验证码 |
| `注册失败` | 注册过程发生异常 | 提示用户稍后重试 |

### 前端处理建议
1. **参数验证**：前端应验证邮箱格式、验证码格式等
2. **密码强度**：建议前端提示用户设置强密码
3. **用户名检查**：可以在注册前调用接口检查用户名是否可用（如果有此接口）
4. **注册成功处理**：注册成功后，引导用户登录
5. **错误处理**：根据不同的错误信息，给用户明确的提示

---

## 3. 邮箱登录

### 接口说明
邮箱登录接口，支持两种登录方式：密码登录和验证码登录。登录失败次数过多会锁定10分钟。

### 接口地址
```
POST /api/sys/emailLogin
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `email` | String | 是 | 邮箱地址 |
| `loginType` | String | 是 | 登录类型：`"password"`-密码登录，`"code"`-验证码登录 |
| `password` | String | 是（密码登录时） | 密码（当loginType为"password"时必填） |
| `captcha` | String | 是（验证码登录时） | 邮箱验证码（当loginType为"code"时必填） |

### 请求示例（密码登录）
```json
{
  "email": "user@example.com",
  "loginType": "password",
  "password": "mypassword"
}
```

### 请求示例（验证码登录）
```json
{
  "email": "user@example.com",
  "loginType": "code",
  "captcha": "123456"
}
```

### 业务逻辑说明

#### 登录流程
1. **登录失败次数检查**：如果该邮箱登录失败次数过多，返回错误："该用户登录失败次数过多，请于10分钟后再次登录！"
2. **用户有效性检查**：检查用户是否存在且有效（未冻结、未删除等）
3. **登录方式验证**：
   - **密码登录**：验证密码是否正确（使用加密后的密码比对）
   - **验证码登录**：验证邮箱验证码是否正确，验证成功后删除验证码
4. **登录成功**：返回用户信息和token

#### 登录失败锁定机制
- 登录失败次数过多会锁定10分钟
- 锁定期间无法登录

#### 验证码验证
- 从Redis中获取验证码：key格式为`email_msg{email}`
- 如果验证码不存在，返回："邮箱验证码失效，请重新获取"
- 如果验证码不匹配，返回："邮箱验证码错误"
- 验证成功后，删除Redis中的验证码

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "登录成功",
  "code": 200,
  "result": {
    "userInfo": {
      "id": "用户ID",
      "username": "用户名",
      "realname": "真实姓名",
      "email": "邮箱地址",
      "phone": "手机号",
      // ... 其他用户信息
    },
    "token": "JWT token",
    "tokenExpireTime": 1234567890,
    // ... 其他登录信息
  },
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "密码错误",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `该用户登录失败次数过多，请于10分钟后再次登录！` | 登录失败次数过多，账户被锁定 | 提示用户等待10分钟后重试 |
| `该用户不存在，请注册` | 用户不存在 | 提示用户注册 |
| `用户已被禁用，请联系管理员` | 用户被禁用 | 提示用户联系管理员 |
| `用户已被删除，请联系管理员` | 用户被删除 | 提示用户联系管理员 |
| `密码不能为空` | 密码登录时未提供密码 | 检查请求参数 |
| `密码错误` | 密码不正确 | 提示用户检查密码 |
| `验证码不能为空` | 验证码登录时未提供验证码 | 检查请求参数 |
| `邮箱验证码失效，请重新获取` | 验证码过期或不存在 | 提示用户重新获取验证码 |
| `邮箱验证码错误` | 验证码不匹配 | 提示用户检查验证码 |
| `登录类型参数错误` | loginType参数值不正确 | 检查请求参数，应为"password"或"code" |

### 前端处理建议
1. **登录方式选择**：提供密码登录和验证码登录两种选择
2. **验证码登录流程**：
   - 用户选择验证码登录
   - 调用发送验证码接口（emailmode="0"）
   - 用户输入验证码
   - 调用登录接口
3. **错误处理**：
   - 登录失败时，根据错误信息给用户提示
   - 登录失败次数过多时，显示倒计时
4. **登录成功处理**：
   - 保存token到本地存储
   - 保存用户信息
   - 跳转到首页或目标页面
5. **安全性**：
   - 密码输入框使用密码类型（type="password"）
   - 不要在控制台输出敏感信息

---

## 4. 重置密码

### 接口说明
通过邮箱验证码重置用户密码接口。用户忘记密码时，可以通过邮箱验证码来重置密码。重置成功后，验证码会被自动删除。

### 接口地址
```
POST /api/sys/user/resetPasswordByEmail
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `email` | String | 是 | 邮箱地址 |
| `emailcode` | String | 是 | 邮箱验证码 |
| `password` | String | 是 | 新密码 |
| `confirmpassword` | String | 是 | 确认密码（必须与新密码一致） |

### 请求示例
```json
{
  "email": "user@example.com",
  "emailcode": "123456",
  "password": "newpassword123",
  "confirmpassword": "newpassword123"
}
```

### 业务逻辑说明

#### 重置密码流程
1. **参数校验**：检查所有必填参数是否为空
2. **密码一致性验证**：验证两次输入的密码是否一致
3. **验证码验证**：从Redis中获取验证码，验证验证码是否正确
4. **用户查找**：通过邮箱查找对应的用户
5. **用户有效性检查**：检查用户是否存在且有效（未冻结、未删除等）
6. **重置密码**：生成新的salt，加密新密码，更新用户密码
7. **清除验证码**：重置成功后，删除Redis中的验证码
8. **记录操作日志**：记录密码重置操作日志

#### 验证码验证
- 从Redis中获取验证码：key格式为`email_msg{email}`
- 如果验证码不存在，返回："邮箱验证码失效，请重新获取！"
- 如果验证码不匹配，返回："邮箱验证码不匹配！"
- 验证成功后，删除Redis中的验证码

#### 密码重置
- 生成8位随机salt
- 使用用户名、新密码和salt进行加密
- 更新用户密码和salt

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "密码重置完成！",
  "code": 200,
  "result": null,
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "两次输入的密码不一致！",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `重置密码失败！参数不能为空` | 必填参数为空 | 检查请求参数，确保所有必填参数都已提供 |
| `两次输入的密码不一致！` | 新密码和确认密码不一致 | 提示用户检查两次输入的密码是否一致 |
| `邮箱验证码失效，请重新获取！` | 验证码过期或不存在 | 提示用户重新获取验证码 |
| `邮箱验证码不匹配！` | 验证码不正确 | 提示用户检查验证码 |
| `未找到该邮箱对应的用户！` | 邮箱未注册 | 提示用户检查邮箱是否正确，或引导用户注册 |
| `用户已被禁用，请联系管理员` | 用户被禁用 | 提示用户联系管理员 |
| `用户已被删除，请联系管理员` | 用户被删除 | 提示用户联系管理员 |

### 前端处理建议
1. **密码强度提示**：建议前端提示用户设置强密码，包含大小写字母、数字和特殊字符
2. **密码一致性验证**：前端应在提交前验证两次密码是否一致
3. **重置密码流程**：
   - 用户点击"忘记密码"
   - 输入邮箱地址
   - 调用发送验证码接口（emailmode="2"）
   - 用户收到验证码邮件
   - 用户输入验证码和新密码
   - 调用重置密码接口
4. **错误处理**：根据不同的错误信息，给用户明确的提示
5. **重置成功处理**：重置成功后，引导用户使用新密码登录
6. **安全性**：
   - 密码输入框使用密码类型（type="password"）
   - 不要在控制台输出敏感信息

---

## 5. 注销账户

### 接口说明
用户注销账户接口。用户需要确认注销风险后，系统会删除所有相关数据（会员数据、充值历史、观看历史、搜索历史等），并对用户名和邮箱进行脱敏处理，然后设置账户为注销状态。注销成功后，token会被清除，用户需要重新登录。

### 接口地址
```
POST /api/sys/user/deleteAccount
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `confirmed` | Boolean | 是 | 确认注销复选框，必须为`true` |

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `X-Access-Token` | String | 是 | 登录后获取的token（如果使用此方式） |

### 请求示例
```json
{
  "confirmed": true
}
```

### 业务逻辑说明

#### 注销流程
1. **登录验证**：从token获取当前登录用户信息
2. **确认验证**：验证用户是否确认注销（confirmed必须为true）
3. **用户有效性检查**：检查用户是否存在且未注销
4. **删除相关数据**：
   - 删除会员表中的金币、积分、VIP权益数据
   - 删除所有充值历史记录（VIP充值、账户充值、消费订单）
   - 删除所有观看历史记录（APP、微信、抖音、快手等）
   - 删除搜索历史记录
5. **数据脱敏**：对用户名和邮箱进行脱敏处理（保留前后部分，中间用***替代）
6. **设置注销状态**：将用户标记为已注销
7. **清除缓存**：清除token缓存、用户权限缓存、用户信息缓存
8. **记录操作日志**：记录账户注销操作日志

#### 数据删除范围
- **会员数据**：金币、积分、VIP权益等（`bx_app_signin_member`表）
- **充值历史**：
  - VIP充值记录（`bx_order_vip_recharge`）
  - 账户充值记录（`bx_order_account_recharge`）
  - 消费订单记录（`bx_order_pay_recharge`）
- **观看历史**：
  - APP观看历史（`bx_app_view_history`）
  - 微信观看历史（`bx_film_view_history`）
  - 抖音观看历史（`bx_douyin_view_history`）
  - 快手观看历史（`ks_film_view_history`）
- **搜索历史**：APP搜索历史（`bx_app_search_history`）

#### 数据脱敏规则
- 用户名和邮箱会进行脱敏处理
- 脱敏规则：
  - 长度≤2：全部替换为`***`
  - 长度≤4：保留首尾各1位，中间用`***`替代
  - 长度>4：保留首尾各2位，中间用`***`替代

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "账户注销成功，所有相关数据已删除",
  "code": 200,
  "result": null,
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "请确认您已了解注销账户的风险并同意注销",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `未找到登录用户信息，请先登录` | 未提供有效的token或token已过期 | 提示用户重新登录 |
| `请确认您已了解注销账户的风险并同意注销` | confirmed参数为false或未提供 | 提示用户勾选确认复选框 |
| `用户不存在` | 用户不存在 | 提示用户检查登录状态 |
| `账户已注销` | 账户已经被注销 | 提示用户账户已注销，无需重复操作 |
| `账户注销失败：xxx` | 注销过程中发生异常 | 提示用户稍后重试或联系管理员 |

### 前端处理建议
1. **登录状态检查**：调用注销接口前，确保用户已登录且token有效
2. **风险提示**：在用户确认注销前，明确提示注销的风险和后果：
   - 所有数据将被永久删除，无法恢复
   - 包括会员数据、充值记录、观看历史、搜索历史等
   - 用户名和邮箱将被脱敏处理
3. **二次确认**：建议添加二次确认对话框，防止误操作
4. **确认复选框**：必须要求用户勾选确认复选框，`confirmed`参数必须为`true`
5. **注销成功处理**：
   - 清除本地存储的token和用户信息
   - 跳转到登录页面或首页
   - 提示用户账户已注销
6. **错误处理**：根据不同的错误信息，给用户明确的提示
7. **安全性**：
   - 确保token在请求头中正确传递
   - 注销成功后立即清除本地token

---

## 完整流程示例

### 邮箱注册流程

```
1. 用户输入邮箱地址
   ↓
2. 前端校验邮箱格式
   ↓
3. 调用发送验证码接口（emailmode="1"）
   POST /api/sys/sendEmailCode
   {
     "email": "user@example.com",
     "emailmode": "1"
   }
   ↓
4. 用户收到验证码邮件
   ↓
5. 用户输入验证码、用户名、密码等信息
   ↓
6. 调用注册接口
   POST /api/sys/user/register
   {
     "email": "user@example.com",
     "emailcode": "123456",
     "username": "myusername",
     "password": "mypassword",
     "realname": "张三"
   }
   ↓
7. 注册成功，引导用户登录
```

### 邮箱验证码登录流程

```
1. 用户输入邮箱地址，选择验证码登录
   ↓
2. 前端校验邮箱格式
   ↓
3. 调用发送验证码接口（emailmode="0"）
   POST /api/sys/sendEmailCode
   {
     "email": "user@example.com",
     "emailmode": "0"
   }
   ↓
4. 用户收到验证码邮件
   ↓
5. 用户输入验证码
   ↓
6. 调用登录接口
   POST /api/sys/emailLogin
   {
     "email": "user@example.com",
     "loginType": "code",
     "captcha": "123456"
   }
   ↓
7. 登录成功，保存token和用户信息
```

### 邮箱密码登录流程

```
1. 用户输入邮箱地址和密码，选择密码登录
   ↓
2. 前端校验邮箱格式和密码
   ↓
3. 调用登录接口
   POST /api/sys/emailLogin
   {
     "email": "user@example.com",
     "loginType": "password",
     "password": "mypassword"
   }
   ↓
4. 登录成功，保存token和用户信息
```

### 重置密码流程

```
1. 用户点击"忘记密码"
   ↓
2. 用户输入邮箱地址
   ↓
3. 前端校验邮箱格式
   ↓
4. 调用发送验证码接口（emailmode="2"）
   POST /api/sys/sendEmailCode
   {
     "email": "user@example.com",
     "emailmode": "2"
   }
   ↓
5. 用户收到验证码邮件
   ↓
6. 用户输入验证码和新密码
   ↓
7. 调用重置密码接口
   POST /api/sys/user/resetPasswordByEmail
   {
     "email": "user@example.com",
     "emailcode": "123456",
     "password": "newpassword123",
     "confirmpassword": "newpassword123"
   }
   ↓
8. 重置成功，引导用户使用新密码登录
```

### 注销账户流程

```
1. 用户已登录（有有效的token）
   ↓
2. 用户进入账户设置页面，点击"注销账户"
   ↓
3. 前端显示注销风险提示：
   - 所有数据将被永久删除，无法恢复
   - 包括会员数据、充值记录、观看历史、搜索历史等
   - 用户名和邮箱将被脱敏处理
   ↓
4. 用户勾选确认复选框，确认了解风险并同意注销
   ↓
5. 调用注销账户接口
   POST /api/sys/user/deleteAccount
   Body:
   {
     "confirmed": true
   }
   ↓
6. 注销成功，清除本地token和用户信息
   ↓
7. 跳转到登录页面，提示用户账户已注销
```

---

## 注意事项

1. **验证码有效期**：验证码有效期为10分钟，过期后需要重新获取
2. **验证码使用**：验证码使用后会被自动删除，不能重复使用
3. **登录失败锁定**：登录失败次数过多会锁定10分钟，锁定期间无法登录
4. **邮箱格式**：邮箱格式必须符合规范：`xxx@xxx.xxx`
5. **用户名唯一性**：注册时用户名必须唯一，如果未提供用户名则使用邮箱作为用户名
6. **密码安全**：建议前端提示用户设置强密码，包含大小写字母、数字和特殊字符
7. **错误处理**：所有接口都返回统一的响应格式，前端应根据`success`字段判断请求是否成功
8. **Token管理**：登录成功后返回的token需要保存到本地存储，后续请求需要携带token
9. **账户注销**：注销账户会永久删除所有相关数据，无法恢复，请谨慎操作

---

## 接口汇总

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 发送邮箱验证码 | POST | `/api/sys/sendEmailCode` | 发送邮箱验证码 |
| 邮箱注册 | POST | `/api/sys/user/register` | 用户注册 |
| 邮箱登录 | POST | `/api/sys/emailLogin` | 邮箱登录 |
| 重置密码 | POST | `/api/sys/user/resetPasswordByEmail` | 通过邮箱验证码重置密码 |
| 注销账户 | POST | `/api/sys/user/deleteAccount` | 注销账户（需登录） |

---

