# 反馈功能API集成文档

---

## 功能

1. **文件上传** - 上传图片文件到云存储，获取文件保存路径
2. **提交反馈** - 提交用户反馈内容，支持文字和图片（多张）
3. **查询反馈列表** - 查询当前用户的反馈历史记录，支持分页

---

## 1. 文件上传

### 接口说明
上传文件到云存储（支持OSS等），返回文件保存路径。该接口用于上传反馈相关的图片文件。

### 接口地址
```
POST /api/appApi/uploadFile
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `file` | MultipartFile | 是 | 要上传的文件 |
| `sysOrgCode` | String | 是 | 部门编号（组织代码） |

### 请求示例

#### Form Data 方式
```
POST /api/appApi/uploadFile
Content-Type: multipart/form-data

file: [文件对象]
sysOrgCode: A01
```

#### JavaScript 示例
```javascript
const formData = new FormData();
formData.append('file', fileObject);
formData.append('sysOrgCode', 'A01');

fetch('/api/appApi/uploadFile', {
  method: 'POST',
  body: formData
})
.then(response => response.json())
.then(data => {
  console.log('上传成功:', data.result.savePath);
});
```

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "savePath": "upload/image/2024/11/xxx.jpg"
  },
  "timestamp": 1234567890
}
```

#### 返回字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `savePath` | String | 文件保存路径，用于提交反馈时传入`picture`字段 |


### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请确定云存储是否配置?` | 该部门未配置云存储信息 | 联系管理员配置云存储 |
| `上传失败！` | 文件上传过程中出错 | 检查文件格式、大小，稍后重试 |

### 前端处理建议

1. **文件格式限制**：建议前端限制图片格式（jpg、png、gif等）
2. **文件大小限制**：建议限制单张图片大小（如5MB以内）
3. **上传进度**：可显示上传进度，提升用户体验
4. **多图上传**：如需上传多张图片，可循环调用此接口，收集所有`savePath`

---

## 2. 提交反馈

### 接口说明
提交用户反馈内容，支持文字反馈和图片反馈（多张图片）。反馈内容会保存到系统中，供管理员查看和处理。

### 接口地址
```
POST /api/appApi/addFeedback
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `content` | String | 是 | 反馈内容 |
| `picture` | String | 否 | 上传图片路径，多张图片用逗号(,)隔开 |
| `createBy` | String | 是 | 创建人ID（当前登录用户ID） |
| `tenantId` | Integer | 是 | 租户ID |

### 请求示例

#### 仅文字反馈
```json
{
  "content": "应用在使用过程中出现闪退问题，希望尽快修复",
  "createBy": "user123",
  "tenantId": 1
}
```

#### 文字+单张图片
```json
{
  "content": "发现了一个界面显示异常的问题",
  "picture": "upload/image/2024/11/xxx.jpg",
  "createBy": "user123",
  "tenantId": 1
}
```

#### 文字+多张图片
```json
{
  "content": "反馈多个问题截图",
  "picture": "upload/image/2024/11/xxx1.jpg,upload/image/2024/11/xxx2.jpg,upload/image/2024/11/xxx3.jpg",
  "createBy": "user123",
  "tenantId": 1
}
```


### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "添加成功！",
  "code": 200,
  "result": null,
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "请传入创建人(createBy)，即当前登录人ID",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 业务逻辑说明

1. **参数校验**：接口会校验`createBy`和`tenantId`是否为空
2. **自动设置时间**：系统会自动设置`createTime`为当前时间
3. **图片路径格式**：多张图片时，路径之间用逗号(,)分隔，不要有空格
4. **数据保存**：反馈数据保存到`mooyu_feedback`表中

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请传入创建人(createBy)，即当前登录人ID` | createBy参数为空 | 检查是否已登录，传入正确的用户ID |
| `请传入租户ID(tenantId)` | tenantId参数为空 | 传入正确的租户ID |

### 前端处理建议

1. **内容校验**：前端应校验反馈内容不能为空，建议设置最小长度（如10个字符）
2. **图片处理**：
   - 先调用上传接口上传图片，获取`savePath`
   - 多张图片时，将所有`savePath`用逗号连接
   - 如果没有图片，可以不传`picture`字段或传空字符串
3. **用户信息**：确保`createBy`和`tenantId`从当前登录用户信息中获取
4. **提交反馈**：
   - 显示提交中状态，防止重复提交
   - 提交成功后，清空表单并提示用户
   - 提交失败时，显示错误信息

---

## 3. 查询反馈列表

### 接口说明
查询当前用户提交的反馈历史记录，支持分页查询。返回的数据按创建时间倒序排列，最新的反馈在最前面。

### 接口地址
```
GET /appApi/feedbackList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `createBy` | String | 是 | 创建人ID（当前登录用户ID） |
| `tenantId` | Integer | 是 | 租户ID |
| `pageNo` | Integer | 否 | 页码，默认值为1 |
| `pageSize` | Integer | 否 | 每页数量，默认值为20 |

### 请求示例

#### URL 方式
```
GET /api/appApi/feedbackList?createBy=user123&tenantId=1&pageNo=1&pageSize=20
```


### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "records": [
      {
        "id": "123456",
        "content": "应用在使用过程中出现闪退问题，希望尽快修复",
        "picture": "upload/image/2024/11/xxx.jpg",
        "createBy": "user123",
        "createTime": "2024-11-20 10:30:00",
        "tenantId": 1
      },
      {
        "id": "123457",
        "content": "发现了一个界面显示异常的问题",
        "picture": "",
        "createBy": "user123",
        "createTime": "2024-11-19 15:20:00",
        "tenantId": 1
      }
    ],
    "total": 2,
    "size": 20,
    "current": 1,
    "pages": 1
  },
  "timestamp": 1234567890
}
```

#### 返回字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `records` | Array | 反馈记录列表 |
| `total` | Long | 总记录数 |
| `size` | Long | 每页数量 |
| `current` | Long | 当前页码 |
| `pages` | Long | 总页数 |

**反馈记录字段说明：**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `id` | String | 反馈ID |
| `content` | String | 反馈内容 |
| `picture` | String | 图片路径，多张图片用逗号(,)隔开，无图片时为空字符串 |
| `createBy` | String | 创建人ID |
| `createTime` | String | 创建时间 |
| `tenantId` | Integer | 租户ID |

### 业务逻辑说明

1. **参数校验**：接口会校验`createBy`和`tenantId`是否为空
2. **查询条件**：只查询当前用户（`createBy`）的反馈记录，且只返回未删除的记录（`del_flag=0`）
3. **排序规则**：按创建时间倒序排列，最新的反馈在最前面
4. **分页支持**：支持分页查询，默认每页20条记录

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `请传入创建人(createBy)，即当前登录人ID` | createBy参数为空 | 检查是否已登录，传入正确的用户ID |
| `请传入租户ID(tenantId)` | tenantId参数为空 | 传入正确的租户ID |

### 前端处理建议

1. **用户信息**：确保`createBy`和`tenantId`从当前登录用户信息中获取
2. **分页加载**：
   - 首次加载时，使用默认的`pageNo=1`和`pageSize=20`
   - 下拉刷新时，重置到第一页
   - 上拉加载更多时，递增`pageNo`
3. **图片处理**：
   - 如果`picture`字段不为空，需要按逗号分割获取多张图片路径
   - 图片路径可能需要拼接完整的URL前缀（根据实际配置）
4. **空状态处理**：当`total`为0时，显示"暂无反馈记录"的提示
5. **日期格式化**：`createTime`字段需要根据实际需求格式化显示（如"2024.11.20"）

---

## 完整使用流程

### 场景1：仅文字反馈
1. 用户输入反馈内容
2. 调用`/api/appApi/addFeedback`接口，只传`content`、`createBy`、`tenantId`

### 场景2：文字+单张图片反馈
1. 用户输入反馈内容，选择一张图片
2. 调用`/api/appApi/uploadFile`上传图片，获取`savePath`
3. 调用`/api/appApi/addFeedback`接口，传入`content`、`picture`（单张图片路径）、`createBy`、`tenantId`

### 场景3：文字+多张图片反馈
1. 用户输入反馈内容，选择多张图片
2. 循环调用`/api/appApi/uploadFile`上传所有图片，收集所有`savePath`
3. 将所有`savePath`用逗号连接成字符串
4. 调用`/api/appApi/addFeedback`接口，传入`content`、`picture`（多张图片路径，逗号分隔）、`createBy`、`tenantId`

---

## 注意事项

1. **图片路径格式**：多张图片时，路径之间必须用逗号(`,`)分隔，不要有空格或其他字符
2. **必填参数**：`content`、`createBy`、`tenantId`为必填参数，`picture`为可选参数
3. **云存储配置**：上传文件前，确保该部门已配置云存储信息
4. **文件大小**：建议前端限制图片大小，避免上传过大文件导致失败
5. **错误处理**：建议前端做好错误处理和用户提示，提升用户体验

