# 搜索功能API集成文档


---

## 功能

1. **查找剧集并记录搜索历史** - 搜索剧集时自动保存到搜索历史
2. **查找搜索历史记录** - 获取用户的搜索历史列表
3. **热点搜索词（支持刷新更换）** - 获取热点搜索词列表，支持刷新更换
4. **热门剧集推荐API** - 获取热门剧集推荐列表

---

## 1. 查找剧集并记录搜索历史

### 接口说明
在图片最上面search input里搜索剧集时，需要提供了`memberId`和搜索关键词，系统会自动将搜索记录保存到搜索历史中。

### 接口地址
```
GET /api/appApi/filmDramaList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `pageNo` | Integer | 是 | 页码，从1开始 |
| `pageSize` | Integer | 是 | 每页数量 |
| `memberId` | String | 是 | 会员ID（可选，如果提供会自动保存搜索历史） |
| `sysOrgCode` | String | 是 | 部门编号 |
| `searchValue` | String | 否 | 搜索关键词（支持剧名、简介、推荐语、制片人名称模糊搜索） |
| `dramaName` | String | 否 | 剧集名称（模糊搜索） |
| `dramaClassify` | String | 否 | 剧集分类ID |
| `specification` | String | 否 | 规格（如：横屏/竖屏） |

### 自动保存搜索历史逻辑
- 当`memberId`、`sysOrgCode`和搜索关键词（`searchValue`或`dramaName`）都存在时，系统会自动保存搜索历史
- 如果相同用户搜索相同关键词已存在，会更新该记录的创建时间为当前时间（保持最新）
- 如果不存在，会创建新的搜索历史记录

### 返回数据格式
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "records": [
      {
        "dramaId": "剧集ID",
        "dramaName": "剧集名称",
        "dramaDescribe": "剧集描述",
        "videoUrl": "封面视频URL",
        "classifyName": "分类名称",
        // ... 其他剧集字段
      }
    ],
    "total": 100,
    "size": 20,
    "current": 1,
    "pages": 5
  },
  "timestamp": 1234567890
}
```

### 前端处理建议
1. **搜索时传递memberId**：如果用户已登录，建议传递`memberId`参数，这样搜索记录会自动保存
2. **搜索关键词处理**：使用`searchValue`参数进行搜索，支持剧名、简介、推荐语、制片人名称的模糊匹配
3. **分页处理**：使用`pageNo`和`pageSize`进行分页，建议每页显示10-20条数据
4. **错误处理**：如果返回`success: false`，显示错误信息`message`给用户

### 示例代码
```javascript
// 搜索剧集
async function searchDrama(keyword, memberId, sysOrgCode, pageNo = 1, pageSize = 20) {
  try {
    const response = await fetch(`/api/appApi/filmDramaList?pageNo=${pageNo}&pageSize=${pageSize}&sysOrgCode=${sysOrgCode}&searchValue=${encodeURIComponent(keyword)}${memberId ? `&memberId=${memberId}` : ''}`);
    const data = await response.json();
    
    if (data.success) {
      // 搜索成功，数据已自动保存到搜索历史（如果提供了memberId）
      return data.result;
    } else {
      console.error('搜索失败:', data.message);
      return null;
    }
  } catch (error) {
    console.error('搜索请求失败:', error);
    return null;
  }
}
```

---

## 2. 查找搜索历史记录

### 接口说明
获取当前用户的搜索历史记录列表，按创建时间倒序排列（最新的在前）。

### 接口地址
```
GET /api/appApi/searchHistoryList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `memberId` | String | 是 | 会员ID |
| `sysOrgCode` | String | 是 | 部门编号 |
| `pageNo` | Integer | 否 | 页码，默认为1 |
| `pageSize` | Integer | 否 | 每页数量，默认为20 |

### 返回数据格式
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "records": [
      {
        "id": "搜索历史ID",
        "memberId": "会员ID",
        "searchKeyword": "搜索关键词",
        "sysOrgCode": "部门编号",
        "createTime": "2024-12-20 10:30:00"
      }
    ],
    "total": 15,
    "size": 20,
    "current": 1,
    "pages": 1
  },
  "timestamp": 1234567890
}
```

### 前端处理建议
1. **显示搜索历史**：在搜索页面展示用户的搜索历史记录
2. **点击历史记录**：用户点击历史记录时，直接使用`searchKeyword`作为搜索关键词调用搜索接口
3. **分页加载**：如果历史记录较多，可以使用分页加载
4. **空状态处理**：如果`records`为空数组，显示"暂无搜索历史"

### 示例代码
```javascript
// 获取搜索历史
async function getSearchHistory(memberId, sysOrgCode, pageNo = 1, pageSize = 20) {
  try {
    const response = await fetch(`/api/appApi/searchHistoryList?memberId=${memberId}&sysOrgCode=${sysOrgCode}&pageNo=${pageNo}&pageSize=${pageSize}`);
    const data = await response.json();
    
    if (data.success) {
      return data.result.records || [];
    } else {
      console.error('获取搜索历史失败:', data.message);
      return [];
    }
  } catch (error) {
    console.error('获取搜索历史请求失败:', error);
    return [];
  }
}

// 点击历史记录搜索
function onHistoryItemClick(keyword) {
  // 使用历史记录的关键词进行搜索
  searchDrama(keyword, memberId, sysOrgCode);
}
```

### 删除搜索历史接口

#### 删除单条记录
```
DELETE /api/appApi/deleteSearchHistory?id={搜索历史ID}
```

#### 清空所有搜索历史
```
DELETE /api/appApi/clearSearchHistory?memberId={会员ID}&sysOrgCode={部门编号}
```

---

## 3. 热点搜索词（支持刷新更换）

### 接口说明
获取热点搜索词列表，支持刷新功能。刷新时会随机排序返回不同的热点词，实现"换一换"的效果。

### 接口地址
```
GET /api/appApi/searchRecommendedList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `sysOrgCode` | String | 是 | 部门编号 |
| `refresh` | Boolean | 否 | 是否刷新（默认false），为true时返回随机排序的结果 |
| `limit` | Integer | 否 | 限制返回数量（可选），不传则默认返回20条，最大限制100条 |

### 返回数据格式
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": [
    {
      "id": "推荐ID",
      "dramaId": "剧目ID",
      "dramaName": "剧目名称（作为搜索关键词）",
      "hotState": 1, //这个字段为1，表示是热门搜索关键词，前端可根据这个字段show 火花
      "sysOrgCode": "部门编号",
      "createTime": "2024-12-20 10:30:00"
    }
  ],
  "timestamp": 1234567890
}
```

### 前端处理建议
1. **首次加载**：不传`refresh`参数或传`refresh=false`，按创建时间倒序显示（默认返回20条）
2. **刷新功能**：点击刷新按钮时，传`refresh=true`，获取随机排序的热点词（实现"换一换"效果）
3. **显示数量控制**：可以使用`limit`参数限制显示数量，例如显示4-10个热点词
   - 不传`limit`：默认返回20条
   - 传入`limit`：返回指定数量（最大100条）
4. **点击热点词**：用户点击热点词时，使用`dramaName`作为搜索关键词调用搜索接口
5. **刷新按钮**：在热点搜索词区域添加刷新图标按钮，点击时调用接口并传`refresh=true`

### 性能优化说明
- ✅ **SQL层面限制**：在数据库查询时直接限制数量，避免查询不必要的数据，提高性能
- ✅ **默认限制**：默认返回20条数据，避免返回过多数据
- ✅ **安全限制**：最大返回数量限制为100条，防止恶意请求

### 示例代码
```javascript
// 获取热点搜索词
async function getHotSearchWords(sysOrgCode, refresh = false, limit = null) {
  try {
    let url = `/api/appApi/searchRecommendedList?sysOrgCode=${sysOrgCode}&refresh=${refresh}`;
    if (limit) {
      url += `&limit=${limit}`;
    }
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.success) {
      return data.result || [];
    } else {
      console.error('获取热点搜索词失败:', data.message);
      return [];
    }
  } catch (error) {
    console.error('获取热点搜索词请求失败:', error);
    return [];
  }
}

// 刷新热点搜索词
async function refreshHotSearchWords(sysOrgCode, limit = 4) {
  return await getHotSearchWords(sysOrgCode, true, limit);
}

// 点击热点词搜索
function onHotWordClick(dramaName) {
  // 使用热点词进行搜索
  searchDrama(dramaName, memberId, sysOrgCode);
}
```

### 使用场景示例
```javascript
// 页面加载时获取热点搜索词（显示4个）
const hotWords = await getHotSearchWords(sysOrgCode, false, 4);

// 用户点击刷新按钮
async function handleRefreshClick() {
  // 显示加载状态
  setLoading(true);
  
  // 刷新获取新的热点词（随机排序）
  const newHotWords = await refreshHotSearchWords(sysOrgCode, 4);
  
  // 更新UI显示
  setHotWords(newHotWords);
  setLoading(false);
}
```

---

## 4. 热门剧集推荐API

### 接口说明
获取热门剧集推荐列表，返回标记为热门（`dramaSign="1"`）的剧集数据。接口会自动筛选启用状态、授权时间有效且标记为热门的剧目。

### 接口地址
```
GET /api/appApi/hotDramaList
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `sysOrgCode` | String | 否 | 部门编号（可选，用于筛选特定部门的数据） |
| `dramaClassify` | String | 否 | 剧集分类ID（可选，支持多个分类，用逗号分隔） |
| `dramaChannel` | String | 否 | 所属频道（可选，1-男生,2-女生） |
| `dramaMode` | String | 否 | 短剧模式（可选，0-免费模式,1-付费模式） |

**注意：** 接口会自动设置以下筛选条件：
- `dramaStatus = "1"`（启用状态）
- `dramaAuthTimeEnd >= 当前日期`（授权时间有效性）
- `dramaSign = "1"`（热门标识）

### 返回数据格式
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": [
    {
      "dramaId": "剧集ID",
      "dramaName": "剧集名称",
      "dramaDescribe": "剧集描述",
      "videoUrl": "封面视频URL",
      "classifyName": "分类名称",
      "totalPlay": "总播放量",
      "dramaPoster": "剧目海报",
      "totalEpisodes": 30,
      "producerName": "制作方名称",
      // ... 其他剧集字段
    }
  ],
  "timestamp": 1234567890
}
```

### 前端处理建议
1. **首次加载**：页面加载时调用接口获取热门剧集列表
2. **列表展示**：返回的是完整列表（非分页），建议前端实现虚拟滚动或分页展示
3. **卡片展示**：建议使用卡片式布局展示推荐剧集，包含封面图、标题、总播放量、描述等信息
4. **点击跳转**：点击卡片跳转到剧集详情页，使用`dramaId`作为参数
5. **空状态处理**：如果`result`为空数组，显示"暂无热门剧集"
6. **播放量显示**：可以使用`totalPlay`字段显示总播放量

### 示例代码
```javascript
// 获取热门剧集推荐
async function getHotDramas(sysOrgCode = null, dramaClassify = null, dramaChannel = null) {
  try {
    let url = `/api/appApi/hotDramaList`;
    const params = [];
    
    if (sysOrgCode) params.push(`sysOrgCode=${sysOrgCode}`);
    if (dramaClassify) params.push(`dramaClassify=${dramaClassify}`);
    if (dramaChannel) params.push(`dramaChannel=${dramaChannel}`);
    
    if (params.length > 0) {
      url += `?${params.join('&')}`;
    }
    
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.success) {
      return data.result || [];
    } else {
      console.error('获取热门剧集失败:', data.message);
      return [];
    }
  } catch (error) {
    console.error('获取热门剧集请求失败:', error);
    return [];
  }
}

// 前端分页展示（如果数据量大）
function displayHotDramasWithPagination(dramas, pageSize = 10) {
  let currentPage = 1;
  const totalPages = Math.ceil(dramas.length / pageSize);
  
  function showPage(page) {
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const pageData = dramas.slice(start, end);
    renderDramasList(pageData);
  }
  
  // 显示第一页
  showPage(1);
  
  // 加载更多
  function loadMore() {
    if (currentPage < totalPages) {
      currentPage++;
      showPage(currentPage);
    } else {
      showNoMoreData();
    }
  }
}
```

---

## 通用说明

### 请求头
所有接口请求需要携带以下请求头（根据实际情况调整）：
```
Content-Type: application/json
Authorization: Bearer {token}  // 如果需要认证
```

### 响应格式
所有接口返回统一的响应格式：
```json
{
  "success": true/false,      // 请求是否成功
  "message": "提示信息",       // 成功或错误信息
  "code": 200,                // 状态码（200表示成功）
  "result": {},                // 返回数据（根据接口不同而不同）
  "timestamp": 1234567890      // 时间戳
}
```


## 完整流程示例

### 搜索页面完整交互流程

```javascript
// 1. 页面初始化
async function initSearchPage() {
  const memberId = getCurrentUserId();
  const sysOrgCode = getSysOrgCode();
  
  // 加载搜索历史
  const history = await getSearchHistory(memberId, sysOrgCode, 1, 10);
  displaySearchHistory(history);
  
  // 加载热点搜索词
  const hotWords = await getHotSearchWords(sysOrgCode, false, 4);
  displayHotWords(hotWords);
  
  // 加载热门剧集推荐
  const dramas = await getHotDramas(sysOrgCode);
  displayHotDramas(dramas);
}

// 2. 用户输入搜索关键词
function onSearchInput(keyword) {
  // 防抖处理
  debounce(() => {
    if (keyword.trim()) {
      searchDrama(keyword, memberId, sysOrgCode);
    }
  }, 300);
}

// 3. 点击搜索历史
function onHistoryClick(keyword) {
  searchDrama(keyword, memberId, sysOrgCode);
}

// 4. 点击热点搜索词
function onHotWordClick(dramaName) {
  searchDrama(dramaName, memberId, sysOrgCode);
}

// 5. 刷新热点搜索词
function onRefreshHotWords() {
  refreshHotSearchWords(sysOrgCode, 4).then(newHotWords => {
    displayHotWords(newHotWords);
  });
}

// 6. 清空搜索历史
async function clearSearchHistory() {
  await fetch(`/api/appApi/clearSearchHistory?memberId=${memberId}&sysOrgCode=${sysOrgCode}`, {
    method: 'DELETE'
  });
  // 重新加载搜索历史
  const history = await getSearchHistory(memberId, sysOrgCode);
  displaySearchHistory(history);
}
```

---

## 注意事项

1. **memberId参数**：在搜索接口中，如果用户已登录，建议传递`memberId`，这样搜索记录会自动保存
2. **sysOrgCode参数**：所有接口都需要`sysOrgCode`参数，需要从用户信息或配置中获取
3. **刷新功能**：热点搜索词的刷新功能通过`refresh=true`参数实现，每次刷新会返回随机排序的结果
4. **分页处理**：搜索和推荐接口都支持分页，建议合理设置`pageSize`，避免一次性加载过多数据
