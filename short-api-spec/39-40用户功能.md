# 用户信息修改API集成文档

---

## 功能

1. **修改用户姓名和头像** - 移动端修改当前登录用户的真实姓名和头像
2. **获取当前用户信息** - 获取当前登录用户的详细信息
3. **查询用户列表** - 根据关键词查询用户列表

---

## 1. 修改用户姓名和头像

### 接口说明
移动端修改用户姓名和头像接口，用于更新当前登录用户的真实姓名和头像。该接口无需admin权限，用户只能修改自己的信息。

### 接口地址
```
PUT /api/sys/user/appUpdateProfile
POST /api/sys/user/appUpdateProfile
```

### 请求头
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `X-Access-Token` | String | 是 | 登录后获取的JWT token |
| `Content-Type` | String | 是 | 固定值：`application/json` |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `realname` | String | 否 | 真实姓名 |
| `avatar` | String | 否 | 头像URL地址（完整URL或相对路径） |

**注意**：
- `realname` 和 `avatar` 至少需要提供一个
- 如果某个字段为空，则不会更新该字段
- 只能修改当前登录用户自己的信息
- **头像上传流程**：如果要上传新头像，需要先调用文件上传接口获取头像URL，然后再调用此接口保存

### 请求示例
```json
{
  "realname": "张三",
  "avatar": "https://example.com/avatar.jpg"
}
```

### 业务逻辑说明

1. **身份验证**：从请求头中的token获取当前登录用户名
2. **用户查询**：根据用户名查询用户信息
3. **参数验证**：检查请求参数，只更新非空字段
4. **数据更新**：
   - 如果提供了`realname`，更新真实姓名
   - 如果提供了`avatar`，更新头像URL
   - 自动更新`updateTime`字段
5. **日志记录**：记录操作日志

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "修改成功!",
  "code": 200,
  "result": {
    "id": "用户ID",
    "username": "用户名",
    "realname": "张三",
    "avatar": "https://example.com/avatar.jpg",
    "email": "user@example.com",
    "phone": "手机号",
    "updateTime": "2024-01-01 12:00:00",
    // ... 其他用户信息
  },
  "timestamp": 1234567890
}
```

#### 失败响应示例
```json
{
  "success": false,
  "message": "未找到对应用户!",
  "code": 500,
  "result": null,
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| `未找到对应用户!` | token无效或用户不存在 | 检查token是否有效，重新登录 |
| `保存失败: xxx` | 数据库更新失败 | 检查服务器日志，稍后重试 |

### 头像上传说明

**重要**：如果要上传新头像，需要先调用文件上传接口获取头像URL，然后再调用此接口保存。

#### 方式一：使用通用上传接口（推荐）

**接口地址**：
```
POST /api/sys/common/upload
```

**请求参数**：
- `file`: 文件对象（MultipartFile）
- `biz`: 业务路径（可选，如：`avatar`）

**返回格式**：
```json
{
  "success": true,
  "message": "文件URL或路径",
  "code": 200
}
```

**使用示例**：
```javascript
// 1. 上传头像文件
const formData = new FormData();
formData.append('file', avatarFile);
formData.append('biz', 'avatar'); // 可选，指定上传目录

const uploadResponse = await fetch('/api/sys/common/upload', {
  method: 'POST',
  headers: {
    'X-Access-Token': token
  },
  body: formData
});

const uploadResult = await uploadResponse.json();
const avatarUrl = uploadResult.message; // 获取上传后的文件URL

// 2. 保存头像URL到用户信息
const updateResponse = await fetch('/api/sys/user/appUpdateProfile', {
  method: 'PUT',
  headers: {
    'X-Access-Token': token,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    avatar: avatarUrl
  })
});
```

#### 方式二：使用AppAPI上传接口

**接口地址**：
```
POST /api/appApi/uploadFile
```

**请求参数**：
- `file`: 文件对象（MultipartFile）
- `sysOrgCode`: 部门编号（组织代码）

**返回格式**：
```json
{
  "success": true,
  "message": "操作成功!",
  "code": 200,
  "result": {
    "savePath": "upload/image/2024/11/xxx.jpg"
  }
}
```

**注意**：此接口返回的是相对路径，需要根据实际情况拼接完整的URL。

### 前端处理建议

1. **Token管理**：确保请求头中包含有效的token
2. **头像上传流程**：
   - 用户选择头像后，先调用上传接口上传文件
   - 获取上传后的文件URL
   - 再调用`appUpdateProfile`接口保存头像URL
3. **参数校验**：前端应先校验参数格式（如头像URL格式、文件大小、文件类型）
4. **错误处理**：根据返回的错误信息，给用户友好的提示
5. **成功反馈**：修改成功后，更新本地用户信息缓存
6. **文件限制**：建议限制头像文件大小（如2MB以内）和格式（jpg、png、gif等）

---

## 2. 获取当前用户信息

### 接口说明
获取当前登录用户的详细信息，包括用户基本信息、字典数据等。

### 接口地址
```
GET /api/sys/user/getUserInfo
```

### 请求头
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `X-Access-Token` | String | 是 | 登录后获取的JWT token |

### 请求参数
无

### 业务逻辑说明

1. **身份验证**：从请求头中的token获取当前登录用户名
2. **用户查询**：根据用户名查询用户信息
3. **数据组装**：返回用户信息和系统字典数据

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "",
  "code": 200,
  "result": {
    "userInfo": {
      "id": "用户ID",
      "username": "用户名",
      "realname": "真实姓名",
      "avatar": "头像URL",
      "email": "邮箱地址",
      "phone": "手机号",
      "sex": 1,
      "birthday": "1990-01-01",
      "status": 1,
      // ... 其他用户信息
    },
    "sysAllDictItems": {
      // 系统字典数据
    }
  },
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| Token无效 | token过期或无效 | 重新登录获取新token |

---

## 3. 查询用户列表

### 接口说明
根据关键词查询用户列表，支持按用户名或真实姓名模糊匹配。

### 接口地址
```
GET /api/sys/user/appQueryUser
```

### 请求头
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `X-Access-Token` | String | 是 | 登录后获取的JWT token |

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `keyword` | String | 否 | 搜索关键词，支持用户名或真实姓名模糊匹配 |
| `username` | String | 否 | 精确查询用户名，支持多个用户名（逗号分隔） |
| `pageNo` | Integer | 否 | 页码，默认1 |
| `pageSize` | Integer | 否 | 每页数量，默认10 |

**注意**：
- `keyword` 和 `username` 不能同时使用
- 如果提供`username`，则按用户名精确查询
- 如果提供`keyword`，则按用户名或真实姓名模糊匹配
- 如果都不提供，则返回所有用户（受分页限制）

### 请求示例
```
GET /api/sys/user/appQueryUser?keyword=张三&pageNo=1&pageSize=10
```

### 业务逻辑说明

1. **参数处理**：
   - 如果提供`username`，按用户名精确查询（支持多个，逗号分隔）
   - 如果提供`keyword`，按用户名或真实姓名模糊匹配
2. **多租户支持**：如果开启多租户，自动过滤当前租户的用户
3. **分页处理**：返回分页结果

### 返回数据格式

#### 成功响应
```json
{
  "success": true,
  "message": "",
  "code": 200,
  "result": [
    {
      "id": "用户ID",
      "username": "用户名",
      "realname": "真实姓名",
      "avatar": "头像URL",
      "email": "邮箱地址",
      "phone": "手机号",
      // ... 其他用户信息
    }
  ],
  "timestamp": 1234567890
}
```

### 常见错误信息

| 错误信息 | 说明 | 处理建议 |
|---------|------|---------|
| Token无效 | token过期或无效 | 重新登录获取新token |

---

## 接口对比

### appUpdateProfile vs appEdit

| 特性 | appUpdateProfile | appEdit |
|------|-----------------|---------|
| 权限要求 | 无需特殊权限 | 需要admin角色 |
| 支持字段 | realname, avatar | realname, avatar, sex, phone, email, birthday |
| 手机号校验 | 无 | 有格式校验 |
| 邮箱校验 | 无 | 有格式校验 |
| 使用场景 | 移动端快速修改姓名和头像 | 完整的用户信息编辑 |

### 使用建议

- **移动端快速修改**：使用 `appUpdateProfile` 接口，简单快捷
- **完整信息编辑**：使用 `appEdit` 接口，支持更多字段和校验

---

## 完整流程示例

### 场景一：仅修改姓名（无需上传文件）

1. **登录获取token**
   ```
   POST /api/sys/emailLogin
   ```

2. **修改用户姓名**
   ```
   PUT /api/sys/user/appUpdateProfile
   Headers: X-Access-Token: {token}
   Body: {
     "realname": "新姓名"
   }
   ```

3. **查询用户信息验证**
   ```
   GET /api/sys/user/getUserInfo
   Headers: X-Access-Token: {token}
   ```

### 场景二：修改头像（需要先上传文件）

1. **登录获取token**
   ```
   POST /api/sys/emailLogin
   ```

2. **上传头像文件**
   ```
   POST /api/sys/common/upload
   Headers: X-Access-Token: {token}
   Content-Type: multipart/form-data
   
   Form Data:
   - file: [头像文件]
   - biz: avatar (可选)
   ```
   
   **响应示例**：
   ```json
   {
     "success": true,
     "message": "https://example.com/upload/avatar/2024/01/xxx.jpg",
     "code": 200
   }
   ```

3. **保存头像URL到用户信息**
   ```
   PUT /api/sys/user/appUpdateProfile
   Headers: X-Access-Token: {token}
   Body: {
     "avatar": "https://example.com/upload/avatar/2024/01/xxx.jpg"
   }
   ```

4. **查询用户信息验证**
   ```
   GET /api/sys/user/getUserInfo
   Headers: X-Access-Token: {token}
   ```

5. **验证修改结果**
   - 检查返回的`userInfo`中的`avatar`是否已更新为新上传的头像URL

### 场景三：同时修改姓名和头像

1. **登录获取token**
   ```
   POST /api/sys/emailLogin
   ```

2. **上传头像文件**（如果需要修改头像）
   ```
   POST /api/sys/common/upload
   Headers: X-Access-Token: {token}
   Content-Type: multipart/form-data
   
   Form Data:
   - file: [头像文件]
   - biz: avatar
   ```

3. **同时修改姓名和头像**
   ```
   PUT /api/sys/user/appUpdateProfile
   Headers: X-Access-Token: {token}
   Body: {
     "realname": "新姓名",
     "avatar": "https://example.com/upload/avatar/2024/01/xxx.jpg"
   }
   ```

4. **查询用户信息验证**
   ```
   GET /api/sys/user/getUserInfo
   Headers: X-Access-Token: {token}
   ```

---

## 注意事项

1. **Token有效期**：token有过期时间，过期后需要重新登录
2. **权限控制**：`appUpdateProfile`接口只能修改当前登录用户自己的信息
3. **头像上传流程**：
   - **必须先上传文件**：如果要修改头像，必须先调用文件上传接口获取头像URL
   - **再保存URL**：获取上传后的文件URL后，再调用`appUpdateProfile`接口保存
   - **不要直接传文件**：`appUpdateProfile`接口不接受文件对象，只接受URL字符串
4. **数据校验**：
   - 虽然接口不强制校验，但建议前端对头像URL格式进行校验
   - 建议限制头像文件大小（如2MB以内）和格式（jpg、png、gif等）
5. **并发更新**：如果多个设备同时修改，后提交的会覆盖先提交的
6. **头像存储**：
   - 头像URL需要是有效的可访问地址
   - 建议使用CDN或对象存储服务
   - 上传接口返回的URL可能是相对路径，需要根据实际情况拼接完整URL
7. **错误处理**：
   - 如果上传失败，不要调用`appUpdateProfile`接口
   - 如果上传成功但保存失败，已上传的文件可能成为孤立文件（需要清理机制）

